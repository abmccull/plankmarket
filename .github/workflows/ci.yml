name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint-and-typecheck:
    name: Lint and Typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript typecheck
        # SKIP_ENV_VALIDATION prevents the T3 env validator from requiring real
        # runtime secrets during a compile-time type-check; the types themselves
        # are still checked in full.
        env:
          SKIP_ENV_VALIDATION: "true"
        run: npx tsc --noEmit

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    env:
      # --- Database ---
      # Dummy local URL — no real DB is needed for a Next.js production build.
      DATABASE_URL: postgresql://postgres:password@localhost:5432/plankmarket

      # --- Supabase ---
      # Required by env.ts (z.string().url() — no default). Must be a real URL shape.
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      # Required by env.ts (z.string().min(1) — no default).
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      # Required by env.ts (z.string().min(1) — no default).
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      # --- Stripe ---
      # Required by env.ts with z.string().startsWith("sk_") — must be the real secret.
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      # Required by env.ts with z.string().startsWith("pk_") — must be the real secret.
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
      # Required by env.ts with z.string().startsWith("whsec_") — must be the real secret.
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}

      # --- Uploadthing ---
      # Required by env.ts (z.string().min(1) — no default).
      UPLOADTHING_TOKEN: ${{ secrets.UPLOADTHING_TOKEN }}

      # --- Resend (Email) ---
      # Optional in env.ts (z.string().startsWith("re_").optional()).
      # Omitting an optional var is safe; passing an empty string would fail the
      # startsWith check — emptyStringAsUndefined:true in env.ts handles this.
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

      # --- Upstash Redis ---
      # Required by env.ts (z.string().url() — no default).
      UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
      # Required by env.ts (z.string().min(1) — no default).
      UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}

      # --- Inngest ---
      # Optional in env.ts.
      INNGEST_EVENT_KEY: ${{ secrets.INNGEST_EVENT_KEY }}
      INNGEST_SIGNING_KEY: ${{ secrets.INNGEST_SIGNING_KEY }}

      # --- Anthropic ---
      # Optional in env.ts.
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      # --- App ---
      NEXT_PUBLIC_APP_URL: http://localhost:3000

      # --- Webhook / internal ---
      # Optional in env.ts (z.string().min(1).optional()).
      VERIFICATION_WEBHOOK_SECRET: dummy-ci-secret
      # Optional in env.ts.
      PRIORITY1_API_KEY: ${{ secrets.PRIORITY1_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
